<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Simulator V3 - Test Suite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .test-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-pass {
            background: #27ae60;
            color: white;
        }
        .status-fail {
            background: #e74c3c;
            color: white;
        }
        .status-pending {
            background: #f39c12;
            color: white;
        }
        .test-actions {
            margin-top: 10px;
        }
        .btn {
            padding: 8px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #229954;
        }
        .console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .result-box {
            margin-top: 10px;
            padding: 15px;
            border-radius: 5px;
            background: #ecf0f1;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        .checklist input[type="checkbox"] {
            margin-right: 10px;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .info {
            color: #3498db;
            font-style: italic;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .test-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-flask"></i> Portfolio Simulator V3 - Test Suite</h1>
        
        <div class="test-section">
            <h2>ðŸŽ¯ Test Overview</h2>
            <p>This test suite validates all V3 features including:</p>
            <ul>
                <li>Natural Language Goal Parsing</li>
                <li>Strategy Generation (Conservative, Balanced, Aggressive)</li>
                <li>Real Listings Integration</li>
                <li>Market Analysis SQL Generation</li>
                <li>End-to-End Workflow</li>
            </ul>
        </div>

        <!-- Goal Parser Tests -->
        <div class="test-section">
            <h2>1. Goal Parser Tests</h2>
            
            <div class="test-case">
                <h3>Test 1.1: Parse Complete Goal</h3>
                <textarea id="goalInput1" class="test-textarea">
I want to generate $10K/month within 36 months. I have $50K to start and can save $2K/month.
                </textarea>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testGoalParser('goalInput1', 'result1')">Run Test</button>
                </div>
                <div id="result1" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 1.2: Parse Partial Goal</h3>
                <textarea id="goalInput2" class="test-textarea">
Need $5000 monthly passive income with $30K capital
                </textarea>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testGoalParser('goalInput2', 'result2')">Run Test</button>
                </div>
                <div id="result2" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 1.3: Parse Complex Goal</h3>
                <textarea id="goalInput3" class="test-textarea">
Build a portfolio for $15K per month rental income within 5 years starting with $100K. Prefer BRRR strategy, aggressive approach is fine.
                </textarea>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testGoalParser('goalInput3', 'result3')">Run Test</button>
                </div>
                <div id="result3" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <!-- Strategy Generator Tests -->
        <div class="test-section">
            <h2>2. Strategy Generator Tests</h2>
            
            <div class="test-case">
                <h3>Test 2.1: Generate Conservative Strategy</h3>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testStrategyGenerator('conservative')">Run Test</button>
                </div>
                <div id="strategyResult1" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 2.2: Generate Balanced Strategy</h3>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testStrategyGenerator('balanced')">Run Test</button>
                </div>
                <div id="strategyResult2" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 2.3: Generate Aggressive Strategy</h3>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testStrategyGenerator('aggressive')">Run Test</button>
                </div>
                <div id="strategyResult3" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <!-- Listings Matcher Tests -->
        <div class="test-section">
            <h2>3. Real Listings Integration Tests</h2>
            
            <div class="test-case">
                <h3>Test 3.1: Match Single Property</h3>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testListingsMatcher('single')">Run Test</button>
                </div>
                <div id="listingsResult1" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 3.2: Match Multiple Properties</h3>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testListingsMatcher('multiple')">Run Test</button>
                </div>
                <div id="listingsResult2" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <!-- SQL Generator Tests -->
        <div class="test-section">
            <h2>4. Market Analysis SQL Generator Tests</h2>
            
            <div class="test-case">
                <h3>Test 4.1: Top Buyers Query</h3>
                <input type="text" id="sqlInput1" class="test-input" value="Show me the top 10 buyers in Detroit">
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testSQLGenerator('sqlInput1', 'sqlResult1')">Run Test</button>
                </div>
                <div id="sqlResult1" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 4.2: Flips Query</h3>
                <input type="text" id="sqlInput2" class="test-input" value="Which properties were flipped in 2024?">
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testSQLGenerator('sqlInput2', 'sqlResult2')">Run Test</button>
                </div>
                <div id="sqlResult2" class="result-box" style="display:none;"></div>
            </div>

            <div class="test-case">
                <h3>Test 4.3: Investor Analysis Query</h3>
                <input type="text" id="sqlInput3" class="test-input" value="Who owns the most properties in 48204?">
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="testSQLGenerator('sqlInput3', 'sqlResult3')">Run Test</button>
                </div>
                <div id="sqlResult3" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <!-- End-to-End Tests -->
        <div class="test-section">
            <h2>5. End-to-End Integration Tests</h2>
            
            <div class="test-case">
                <h3>Test 5.1: Complete V3 Workflow</h3>
                <p>This test runs through the entire V3 workflow:</p>
                <ol>
                    <li>Parse natural language goal</li>
                    <li>Generate strategies</li>
                    <li>Apply to timeline</li>
                    <li>Match real listings</li>
                </ol>
                <div class="test-actions">
                    <button class="btn btn-success" onclick="testEndToEnd()">Run Complete Test</button>
                </div>
                <div id="e2eResult" class="result-box" style="display:none;"></div>
            </div>
        </div>

        <!-- Manual Testing Checklist -->
        <div class="test-section">
            <h2>6. Manual Testing Checklist</h2>
            <p>Complete these manual tests on both local and live environments:</p>
            
            <h3>V3 Goal Input & Strategy Generation:</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Enter a natural language goal in V3 interface</li>
                <li><input type="checkbox"> Verify goal is parsed correctly (check displayed values)</li>
                <li><input type="checkbox"> Confirm 3 strategy cards appear (Conservative, Balanced, Aggressive)</li>
                <li><input type="checkbox"> Click each strategy card and verify timeline updates</li>
                <li><input type="checkbox"> Test example queries by clicking suggestion chips</li>
            </ul>

            <h3>Real Listings Integration:</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Toggle "Use Real Listings" switch</li>
                <li><input type="checkbox"> Verify loading message appears</li>
                <li><input type="checkbox"> Check that property names change to real addresses</li>
                <li><input type="checkbox"> Verify Zillow links appear for matched properties</li>
                <li><input type="checkbox"> Confirm unmatched properties retain generic names</li>
            </ul>

            <h3>Market Analysis Tool:</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Navigate to Market Analysis page</li>
                <li><input type="checkbox"> Test each example query</li>
                <li><input type="checkbox"> Verify results display in table format</li>
                <li><input type="checkbox"> Test CSV export functionality</li>
                <li><input type="checkbox"> Test JSON export functionality</li>
                <li><input type="checkbox"> Check query history updates after each query</li>
            </ul>

            <h3>Navigation & UI:</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Verify V3 link appears in main navigation</li>
                <li><input type="checkbox"> Verify Market Analysis link appears in navigation</li>
                <li><input type="checkbox"> Test responsive design on mobile viewport</li>
                <li><input type="checkbox"> Check all error states display properly</li>
                <li><input type="checkbox"> Verify loading states work correctly</li>
            </ul>

            <h3>Integration with V2:</h3>
            <ul class="checklist">
                <li><input type="checkbox"> Confirm V2 calculator functionality still works</li>
                <li><input type="checkbox"> Verify timeline table updates properly</li>
                <li><input type="checkbox"> Check financial projections update correctly</li>
                <li><input type="checkbox"> Test manual timeline editing after V3 generation</li>
                <li><input type="checkbox"> Verify cash flow calculations are accurate</li>
            </ul>
        </div>

        <!-- Test Results Summary -->
        <div class="test-section">
            <h2>Test Results Summary</h2>
            <div id="testSummary" class="result-box">
                <p>Run all tests to see summary...</p>
            </div>
        </div>
    </div>

    <!-- Load V3 Scripts -->
    <script src="js/goal-parser.js"></script>
    <script src="js/strategy-generator.js"></script>
    <script src="js/listings-matcher.js"></script>
    <script src="js/sql-generator.js"></script>
    <script src="js/property-api.js"></script>

    <script>
        // Test Results Storage
        const testResults = {
            goalParser: [],
            strategyGenerator: [],
            listingsMatcher: [],
            sqlGenerator: [],
            endToEnd: []
        };

        // Test Goal Parser
        function testGoalParser(inputId, resultId) {
            const input = document.getElementById(inputId).value;
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            
            try {
                const parser = new GoalParser();
                const result = parser.parse(input);
                const confidence = parser.getConfidence(result);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ“ Goal parsed successfully!</div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                    <div class="info">Confidence Score: ${confidence.score}% (${confidence.fieldsFound} fields found)</div>
                `;
                
                testResults.goalParser.push({ test: inputId, status: 'pass', result });
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âœ— Parse failed: ${error.message}</div>
                `;
                testResults.goalParser.push({ test: inputId, status: 'fail', error: error.message });
            }
            
            updateSummary();
        }

        // Test Strategy Generator
        async function testStrategyGenerator(approach) {
            const resultDiv = document.getElementById(`strategyResult${approach === 'conservative' ? '1' : approach === 'balanced' ? '2' : '3'}`);
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">Generating strategy...</div>';
            
            try {
                const generator = new StrategyGenerator();
                const testGoal = {
                    targetMonthlyIncome: 10000,
                    timeHorizon: 36,
                    startingCapital: 50000,
                    monthlyContributions: 2000
                };
                
                const strategy = await generator.generateStrategy(testGoal, approach);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ“ ${approach} strategy generated!</div>
                    <div>Properties: ${strategy.propertyCount}</div>
                    <div>Time to Goal: ${strategy.monthsToGoal} months</div>
                    <div>Total Investment: $${strategy.totalInvestment.toLocaleString()}</div>
                    <div>Final Income: $${strategy.finalMonthlyIncome.toLocaleString()}/month</div>
                    <div>Timeline Events: ${strategy.timeline.length}</div>
                    <details>
                        <summary>View Full Strategy</summary>
                        <pre>${JSON.stringify(strategy, null, 2)}</pre>
                    </details>
                `;
                
                testResults.strategyGenerator.push({ test: approach, status: 'pass', result: strategy });
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âœ— Strategy generation failed: ${error.message}</div>
                `;
                testResults.strategyGenerator.push({ test: approach, status: 'fail', error: error.message });
            }
            
            updateSummary();
        }

        // Test Listings Matcher
        async function testListingsMatcher(type) {
            const resultDiv = document.getElementById(`listingsResult${type === 'single' ? '1' : '2'}`);
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">Testing listings matcher...</div>';
            
            try {
                const matcher = new ListingsMatcher();
                
                // Create test timeline
                const testTimeline = type === 'single' ? 
                    [{ id: 1, month: 1, action: 'buy', property: 'Test Property 1', price: 65000 }] :
                    [
                        { id: 1, month: 1, action: 'buy', property: 'Test Property 1', price: 65000 },
                        { id: 2, month: 3, action: 'buy', property: 'Test Property 2', price: 75000 },
                        { id: 3, month: 6, action: 'buy', property: 'Test Property 3', price: 55000 }
                    ];
                
                // Note: This will fail without API key, but we can test the structure
                resultDiv.innerHTML = `
                    <div class="success">âœ“ Listings matcher initialized!</div>
                    <div>Test Timeline: ${testTimeline.length} properties</div>
                    <div class="info">Note: Actual API calls require valid Zillow API key</div>
                    <details>
                        <summary>View Test Data</summary>
                        <pre>${JSON.stringify(testTimeline, null, 2)}</pre>
                    </details>
                `;
                
                testResults.listingsMatcher.push({ test: type, status: 'pass', note: 'Structure test only' });
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âœ— Listings matcher test failed: ${error.message}</div>
                `;
                testResults.listingsMatcher.push({ test: type, status: 'fail', error: error.message });
            }
            
            updateSummary();
        }

        // Test SQL Generator
        function testSQLGenerator(inputId, resultId) {
            const input = document.getElementById(inputId).value;
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            
            try {
                const generator = new SQLGenerator();
                const result = generator.generateQuery(input);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ“ SQL query generated!</div>
                    <div><strong>Type:</strong> ${result.type}</div>
                    <div><strong>Description:</strong> ${result.description}</div>
                    <div><strong>SQL:</strong></div>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px;">${result.sql}</pre>
                `;
                
                testResults.sqlGenerator.push({ test: inputId, status: 'pass', result });
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âœ— SQL generation failed: ${error.message}</div>
                `;
                testResults.sqlGenerator.push({ test: inputId, status: 'fail', error: error.message });
            }
            
            updateSummary();
        }

        // Test End-to-End
        async function testEndToEnd() {
            const resultDiv = document.getElementById('e2eResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">Running end-to-end test...</div>';
            
            const steps = [];
            
            try {
                // Step 1: Parse Goal
                steps.push('<div class="info">Step 1: Parsing goal...</div>');
                const parser = new GoalParser();
                const goal = parser.parse("I want to generate $10K/month within 36 months. I have $50K to start and can save $2K/month.");
                steps.push('<div class="success">âœ“ Goal parsed successfully</div>');
                
                // Step 2: Generate Strategy
                steps.push('<div class="info">Step 2: Generating strategies...</div>');
                const generator = new StrategyGenerator();
                const strategies = await generator.generateMultipleStrategies(goal);
                steps.push(`<div class="success">âœ“ Generated ${strategies.length} strategies</div>`);
                
                // Step 3: Validate Timeline
                steps.push('<div class="info">Step 3: Validating timeline structure...</div>');
                const hasValidTimeline = strategies.every(s => s.timeline && s.timeline.length > 0);
                if (hasValidTimeline) {
                    steps.push('<div class="success">âœ“ All strategies have valid timelines</div>');
                } else {
                    throw new Error('Invalid timeline structure');
                }
                
                // Step 4: Test SQL Generator
                steps.push('<div class="info">Step 4: Testing SQL generator...</div>');
                const sqlGen = new SQLGenerator();
                const sqlQuery = sqlGen.generateQuery("Show me top buyers");
                steps.push('<div class="success">âœ“ SQL generator working</div>');
                
                resultDiv.innerHTML = `
                    <div class="success">âœ“ End-to-End Test Completed!</div>
                    ${steps.join('')}
                    <div style="margin-top: 10px;">
                        <strong>Summary:</strong>
                        <ul>
                            <li>Goal parsed: ${goal.targetMonthlyIncome}/month in ${goal.timeHorizon} months</li>
                            <li>Strategies generated: ${strategies.length}</li>
                            <li>Average properties needed: ${Math.round(strategies.reduce((sum, s) => sum + s.propertyCount, 0) / strategies.length)}</li>
                            <li>SQL generator functional: Yes</li>
                        </ul>
                    </div>
                `;
                
                testResults.endToEnd.push({ status: 'pass', steps: steps.length });
            } catch (error) {
                resultDiv.innerHTML = `
                    ${steps.join('')}
                    <div class="error">âœ— End-to-end test failed: ${error.message}</div>
                `;
                testResults.endToEnd.push({ status: 'fail', error: error.message });
            }
            
            updateSummary();
        }

        // Update Summary
        function updateSummary() {
            const summary = document.getElementById('testSummary');
            
            const totalTests = Object.values(testResults).reduce((sum, category) => sum + category.length, 0);
            const passedTests = Object.values(testResults).reduce((sum, category) => 
                sum + category.filter(t => t.status === 'pass').length, 0);
            
            const categoryResults = Object.entries(testResults).map(([category, tests]) => {
                const passed = tests.filter(t => t.status === 'pass').length;
                const total = tests.length;
                return `<li>${category}: ${passed}/${total} passed</li>`;
            }).join('');
            
            summary.innerHTML = `
                <h3>Overall Results: ${passedTests}/${totalTests} tests passed</h3>
                <ul>${categoryResults}</ul>
                <div class="info">
                    Test completion: ${Math.round((totalTests / 14) * 100)}%
                </div>
            `;
        }

        // Run all tests on load (optional)
        function runAllTests() {
            console.log('Running all V3 tests...');
            // You can uncomment these to auto-run tests
            // testGoalParser('goalInput1', 'result1');
            // testStrategyGenerator('conservative');
            // etc...
        }
    </script>
</body>
</html>